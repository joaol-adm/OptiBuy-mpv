<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>OptiBuy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bibliotecas externas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tablesort@5.2.1/dist/tablesort.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
  h2 { color: #974706; }
  h3 { color: #004080; } 
  h4 { color: #EAB200; } 
  h5 { color: #EE0000; } 
    input[type="file"], input[type="text"], select { margin-bottom: 10px; display: block; }
    button { margin: 10px 5px; padding: 8px 12px; }
    table { border-collapse: collapse; margin-top: 20px; font-size: 14px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: right; }
    th { background-color: #f0f0f0; text-align: center; cursor: pointer; }
    td:first-child, th:first-child, td:nth-child(2), th:nth-child(2) { text-align: left; }
    input[type="number"] { width: 80px; }

    .azul-claro { background-color: #d0ebff; }
    .verde-claro { background-color: #d3f9d8; }
    .laranja-claro { background-color: #ffe8cc; }
    .amarelo-claro { background-color: #fff9c4; }
    .vermelho-claro { background-color: #ffcdd2; }
    .cinza-claro { background-color: #eeeeee; }

    .filtros { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
    .filtros div { display: flex; flex-direction: column; font-size: 14px; }
    .filtros input { padding: 4px; }

    .processing-message {
      display: none;
      font-weight: bold;
      color: #004080;
      margin-top: 10px;
      align-items: center;
      gap: 10px;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #004080;
      border-radius: 50%;
      width: 18px; height: 18px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

    details { margin: 12px 0; }
    details summary { cursor: pointer; font-weight: bold; }
    .remote-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 10px; }
    .remote-item { border: 1px solid #e5e5e5; border-radius: 8px; padding: 8px 10px; }
    .remote-item label { display: block; font-weight: bold; margin-bottom: 4px; }
    .small { font-size: 12px; color: #666; }
    code { background: #f7f7f7; padding: 0 4px; border-radius: 4px; }
  </style>
</head>
<body>

<!--

https://joaol-adm.github.io/OptiBuy-mpv/OptiBuy_logo.png
<img src="OpTiBuy_logo.png" alt="Logo do Sistema" style="height: 50px;">


-->

<div style="display: flex; align-items: center; gap: 10px;">
  <img src="https://joaol-adm.github.io/OptiBuy-mpv/OptiBuy_logo.png" alt="Logo do Sistema" style="height: 80px;">
  <h2 style="margin: 0;"> OptiBuy | Compra Perfeita </h2>
</div>

   <h5>Uso Exclusivo BK Sorocaba Shoppping  |  Powered by OpTiXis  |  All Rights Reserved  </h5>

  <label>SELECIONE PASTA DE TRABALHO:</label>
  <input type="file" id="folderUpload" webkitdirectory directory multiple />
  <button onclick="carregarArquivosDaPasta()">Carregar arquivos da pasta</button>

<!--

  <details>
    <summary>➕ Carregar arquivos direto do GitHub (remoto primeiro; local sobrepõe)</summary>
    <p class="small">
      Os arquivos remotos são buscados a partir de <code>BASE_REMOTE_URL</code> e devem se chamar <code>BKQBF_TAB-1.csv/.xlsx</code> até <code>BKQBF_TAB-8.csv/.xlsx</code>.<br>
      Se o usuário selecionar um arquivo local para uma TAB, <b>o local tem prioridade</b> e substitui o remoto.
    </p>
    <div class="remote-grid">
      <div class="remote-item"><label><input type="checkbox" id="remote_tab_1" checked> Usar remoto TAB-1</label><div class="small">produtos_compra</div></div>
      <div class="remote-item"><label><input type="checkbox" id="remote_tab_2" checked> Usar remoto TAB-2</label><div class="small">entrega</div></div>
      <div class="remote-item"><label><input type="checkbox" id="remote_tab_3" checked> Usar remoto TAB-3</label><div class="small">produtos_venda</div></div>
      <div class="remote-item"><label><input type="checkbox" id="remote_tab_4" checked> Usar remoto TAB-4</label><div class="small">receita</div></div>
      <div class="remote-item"><label><input type="checkbox" id="remote_tab_5" checked> Usar remoto TAB-5</label><div class="small">packing_list</div></div>
      <div class="remote-item"><label><input type="checkbox" id="remote_tab_6" checked> Usar remoto TAB-6</label><div class="small">tabela_precos_platlog</div></div>
      <div class="remote-item"><label><input type="checkbox" id="remote_tab_7" checked> Usar remoto TAB-7</label><div class="small">tabela_precos_ambev</div></div>
      <div class="remote-item"><label><input type="checkbox" id="remote_tab_8" checked> Usar remoto TAB-8</label><div class="small">stock</div></div>
    </div>
    <div style="margin-top:10px">
      <label style="font-weight:bold">BASE REMOTA (GitHub Pages):</label>
      <input type="text" id="remote_base_input" style="width:100%" placeholder="https://joaol-adm.github.io/OptiBuy-mpv/" />
      <div class="small">Se vazio, usa a constante <code>BASE_REMOTE_URL</code> do script.</div>
    </div>
  </details>

-->

  <div>
    <label>PRODUTOS_COMPRA:</label>
    <input type="file" id="produtos_compra" accept=".csv,.xlsx">
    <label>ENTREGA:</label>
    <input type="file" id="entrega" accept=".csv,.xlsx">
    <label>PRODUTOS_VENDA:</label>
    <input type="file" id="produtos_venda" accept=".csv,.xlsx">
    <label>RECEITA:</label>
    <input type="file" id="receita" accept=".csv,.xlsx">
    <label>PACKING_LIST:</label>
    <input type="file" id="packing_list" accept=".csv,.xlsx">
    <label>TABELA_PRECOS_PLATLOG:</label>
    <input type="file" id="tabela_precos_platlog" accept=".csv,.xlsx">
    <label>TABELA_PRECOS_AMBEV:</label>
    <input type="file" id="tabela_precos_ambev" accept=".csv,.xlsx">     
    <label>STOCK:</label>     
    <input type="file" id="stock" accept=".csv,.xlsx">

    <button onclick="processar()">REPROCESSAR</button>
    <button onclick="exportar()">Exportar para XLSX</button>

    <div class="processing-message" id="processingMessage">
      <div class="spinner"></div>
      <span>Aguarde! Processando...</span>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="filtros">
    <div>
      <label>DESCRICAO contém:</label>
      <input type="text" id="filtroDescricao" oninput="aplicarFiltrosExternos()">
    </div>
    <div>
      <label>Receber (min):</label>
      <input type="number" id="filtroReceberMin" oninput="aplicarFiltrosExternos()">
      <label>Receber (max):</label>
      <input type="number" id="filtroReceberMax" oninput="aplicarFiltrosExternos()">
    </div>
    <div>
      <label>ESTOQUE (min):</label>
      <input type="number" id="filtroEstoqueMin" oninput="aplicarFiltrosExternos()">
      <label>ESTOQUE (max):</label>
      <input type="number" id="filtroEstoqueMax" oninput="aplicarFiltrosExternos()">
    </div>
    <div>
      <label>ReporEstoque (min):</label>
      <input type="number" id="filtroReporEstoqueMin" oninput="aplicarFiltrosExternos()">
      <label>ReporEstoque (max):</label>
      <input type="number" id="filtroReporEstoqueMax" oninput="aplicarFiltrosExternos()">
    </div>
    <div>
      <label>COMPRAR (min):</label>
      <input type="number" id="filtroComprarMin" oninput="aplicarFiltrosExternos()">
      <label>COMPRAR (max):</label>
      <input type="number" id="filtroComprarMax" oninput="aplicarFiltrosExternos()">
    </div>
  </div>

  <div id="tabelaResultado"></div>

  <script>
    /* =========================
       CONFIG REMOTA / PRIORIDADE
       ========================= */
    // >>> TROQUE A URL ABAIXO PELO SEU CAMINHO DE PÁGINA NO GITHUB PAGES (TERMINE COM "/")
    const BASE_REMOTE_URL = "https://joaol-adm.github.io/OptiBuy-mpv/"; 
    const REMOTO_PRIMEIRO = true; // tenta remoto primeiro; se houver arquivo local, local sobrepõe
    // Quais TABs usar remotamente por padrão (1..8). Marque/desmarque em tempo real pelos checkboxes.
    const TABS_POR_PADRAO_REMOTAS = new Set([1,2,3,4,5,6,7,8]);

    /* =========================
       VARIÁVEIS GLOBAIS
       ========================= */
    let dadosGlobais = {};
    let planilhaFinal = [];

    const mapaArquivos = {
      "BKQBF_TAB-1": "produtos_compra",
      "BKQBF_TAB-2": "entrega",
      "BKQBF_TAB-3": "produtos_venda",
      "BKQBF_TAB-4": "receita",
      "BKQBF_TAB-5": "packing_list",
      "BKQBF_TAB-6": "tabela_precos_platlog",
      "BKQBF_TAB-7": "tabela_precos_ambev",
      "BKQBF_TAB-8": "stock"
    };

    function tabNumberFromInternalId(internalId) {
      for (const chave in mapaArquivos) {
        if (mapaArquivos[chave] === internalId) {
          const n = parseInt(chave.split('-')[1], 10);
          return Number.isFinite(n) ? n : null;
        }
      }
      return null;
    }

    function getRemoteBase() {
      const ui = document.getElementById("remote_base_input")?.value?.trim();
      if (ui) return ui.endsWith("/") ? ui : (ui + "/");
      return BASE_REMOTE_URL.endsWith("/") ? BASE_REMOTE_URL : (BASE_REMOTE_URL + "/");
    }

    function isTabRemota(n) {
      const ui = document.getElementById("remote_tab_" + n);
      if (ui) return ui.checked;
      return TABS_POR_PADRAO_REMOTAS.has(n);
    }

    function nomesRemotosParaTAB(n) {
      return [`BKQBF_TAB-${n}.csv`, `BKQBF_TAB-${n}.xlsx`];
    }

    async function lerCSVtextoComoJSON(texto) {
      const wb = XLSX.read(texto, { type: 'string' });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      return XLSX.utils.sheet_to_json(sheet, { defval: '' });
    }

    async function lerArrayBufferComoJSON(buf) {
      const wb = XLSX.read(buf, { type: 'array' });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      return XLSX.utils.sheet_to_json(sheet, { defval: '' });
    }

    async function lerRemotoPorNome(base, nomeArquivo) {
      const url = base + nomeArquivo;
      const lower = nomeArquivo.toLowerCase();

      const resp = await fetch(url, { cache: 'no-store' });
      if (!resp.ok) throw new Error(`Falha ao baixar ${url} [${resp.status}]`);

      if (lower.endsWith(".csv")) {
        const texto = await resp.text();
        return await lerCSVtextoComoJSON(texto);
      }
      if (lower.endsWith(".xlsx")) {
        const buf = await resp.arrayBuffer();
        return await lerArrayBufferComoJSON(buf);
      }
      throw new Error(`Extensão não suportada em ${nomeArquivo}`);
    }

    async function lerRemotoTAB(n) {
      const base = getRemoteBase();
      let ultimaFalha = null;
      for (const nome of nomesRemotosParaTAB(n)) {
        try {
          return await lerRemotoPorNome(base, nome);
        } catch (e) {
          ultimaFalha = e;
        }
      }
      throw ultimaFalha || new Error(`Não foi possível carregar remotamente TAB-${n}`);
    }

    async function lerArquivoLocal(input) {
      return new Promise((resolve) => {
        const file = input?.files?.[0];
        if (!file) return resolve([]);
        const reader = new FileReader();
        reader.onload = (e) => {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
          resolve(json);
        };
        reader.readAsArrayBuffer(file);
      });
    }

    /* =========================
       PIPELINE PRINCIPAL
       ========================= */
    async function processar() {
      const arquivos = [
        'produtos_compra', 'entrega', 'produtos_venda', 'receita',
        'packing_list', 'tabela_precos_platlog', 'tabela_precos_ambev', 'stock'
      ];

      // document.getElementById('processingMessage').style.display = 'flex';

  const mm = document.getElementById('processingMessage');
  mm.style.display = 'flex';  // liga só quando o usuário clica
  try {

      dadosGlobais = {};

      for (const id of arquivos) {
        const tabNum = tabNumberFromInternalId(id);
        const inputEl = document.getElementById(id);
        const temLocal = inputEl?.files?.length > 0;

        // Estratégia: remoto primeiro (se marcado) e, se houver local, local sobrepõe.
        let carregadoRemoto = false;

        if (REMOTO_PRIMEIRO && tabNum && isTabRemota(tabNum)) {
          try {
            dadosGlobais[id] = await lerRemotoTAB(tabNum);
            carregadoRemoto = true;
          } catch (e) {
            console.warn(`Remoto falhou TAB-${tabNum}:`, e);
            dadosGlobais[id] = [];
          }
        } else {
          dadosGlobais[id] = [];
        }

        if (temLocal) {
          try {
            const localJSON = await lerArquivoLocal(inputEl);
            if (localJSON?.length) {
              // Local tem prioridade
              dadosGlobais[id] = localJSON;
            }
          } catch (e) {
            console.error(`Falha ao ler local para ${id}:`, e);
            // se remoto já carregou, mantemos; se não, fica []
          }
        }

        // Se não é remoto-primeiro, alternativa seria: ler local primeiro e, se vazio e remoto marcado, tentar remoto.
      }

      // ==== Seu processamento original, inalterado ====
      const compra = dadosGlobais['produtos_compra'];
      const entrega = Object.fromEntries((dadosGlobais['entrega'] || []).map(e => [e.CODRECEBE, e.Receber]));
      const packing = Object.fromEntries((dadosGlobais['packing_list'] || []).map(p => [p.CODPL, p.CAIXA]));
      const platlog = Object.fromEntries((dadosGlobais['tabela_precos_platlog'] || []).map(p => [p.CODPRECO, p.CODIGOSAP]));
      const estoqueMap = Object.fromEntries((dadosGlobais['stock'] || []).map(s => [s.CODSTK, parseFloat(s.ESTOQUE) || 0]));

      const venda = dadosGlobais['produtos_venda'] || [];
      const receita = dadosGlobais['receita'] || [];

      const ultimos14Dias = [...new Set(venda.map(v => v.Dia))]
        .filter(d => d)
        .sort((a, b) => new Date(b) - new Date(a))
        .slice(0, 14);

      let tabela = [];

      for (const item of (compra || [])) {
        const codplat = item.CODPLAT;
        const desc = item.DESCRICAO || '';
        const caixa = parseFloat(packing[codplat]) || 0;
        const receber = parseFloat(entrega[codplat]) || 0;
        const proxEntregaQtde = caixa * receber;
        const codigosap = platlog[codplat];
        const estoque = estoqueMap[codplat] || 0;

        let diasValores = {};
        for (const dia of ultimos14Dias) {
          let valorTotal = 0;
          const vendasDoDia = venda.filter(v => v.Dia === dia);
          for (const v of vendasDoDia) {
            const receitaFiltrada = receita.filter(r => r.Material == v.Codigo && r.Componente == codigosap);
            for (const r of receitaFiltrada) {
              const qtd = parseFloat(r['Qtd.']) || 0;
              const qtdeVenda = parseFloat(v.Qtde) || 0;
              valorTotal += qtd * qtdeVenda;
            }
          }
          diasValores[dia] = valorTotal;
        }

        const valores = ultimos14Dias.map(d => diasValores[d] || 0);
        const media7 = (valores.slice(0, 7).reduce((a, b) => a + b, 0) / 7).toFixed(1);
        const media14 = (valores.reduce((a, b) => a + b, 0) / 14).toFixed(1);
        const pico14 = Math.max(...valores, 0).toFixed(1);

        let diasDeEstoque = 100;
        if (parseFloat(media7) > 0) {
          diasDeEstoque = ((estoque + proxEntregaQtde) / parseFloat(media7)).toFixed(1);
        }

        let reporstk = (10 - diasDeEstoque) * parseFloat(media7);
        reporstk = reporstk > 0 ? reporstk.toFixed(1) : "0";

  	let sugestcx = 0;
	if (caixa > 0) {
  	sugestcx = Math.ceil(parseFloat(reporstk) / caixa);
	}


        let linha = {
          CODPLAT: codplat,
          DESCRICAO: desc,
          CAIXA: caixa,
          Receber: receber,
          ProxEntregaQtde: proxEntregaQtde,
          ESTOQUE: estoque,
          DiasDeEstoque: diasDeEstoque,
          ReporEstoque: reporstk,
	  SugestaoCompra: sugestcx,
          COMPRAR: 0,
          'Media-7': media7,
          'Media-14': media14,
          'Pico-14': pico14,
        };

        for (const dia of ultimos14Dias) {
          linha[dia] = (diasValores[dia] || 0).toFixed(1);
        }

        tabela.push(linha);
      }

      planilhaFinal = tabela;
      mostrarTabela(tabela, ultimos14Dias);

      // Salva no localStorage
      localStorage.setItem('planilhaFinal', JSON.stringify(planilhaFinal));

  } finally {
    mm.style.display = 'none'; // desliga SEMPRE ao terminar
  }

   //   document.getElementById('processingMessage').style.display = 'none';

    }

    function mostrarTabela(tabela, dias) {
      let html = '<table id="tabela"><thead><tr>';
      const colunasFixas = ["CODPLAT", "DESCRICAO", "CAIXA", "Receber", "ProxEntregaQtde", "ESTOQUE", "DiasDeEstoque", "ReporEstoque", "SugestaoCompra", "COMPRAR", "Media-7", "Media-14", "Pico-14"];
      html += colunasFixas.map(c => `<th>${c}</th>`).join('');
      html += dias.map(d => `<th>${d}</th>`).join('');
      html += '</tr></thead><tbody>';

      tabela.forEach((row, i) => {
        html += '<tr>';
        colunasFixas.forEach(col => {
          let val = row[col];
          let classe = '';
          if (col === 'Media-7' || col === 'Media-14') classe = 'azul-claro';
          if (col === 'Pico-14') classe = 'laranja-claro';
          if (col === 'DiasDeEstoque') {
            if (val == 100) classe = 'vermelho-claro';
            else if (val > 0 && val <= 5.9) classe = 'laranja-claro';
            else if (val > 5.9 && val <= 7) classe = 'amarelo-claro';
            else if (val > 7) classe = 'verde-claro';
          }
          if (col === 'ReporEstoque' && parseFloat(val) > 0) classe = 'cinza-claro';
          if (col === 'SugestaoCompra' && parseFloat(val) > 0) classe = 'cinza-claro';

          if (col === 'ProxEntregaQtde' && val > 0) classe = 'verde-claro';

          if (col === 'COMPRAR') {
            html += `<td><input type="number" value="${val}" onchange="planilhaFinal[${i}].COMPRAR = parseInt(this.value) || 0; salvarLocalStorage()"></td>`;
          } else {
            html += `<td class="${classe}">${val}</td>`;
          }
        });
        dias.forEach(d => html += `<td>${tabela[i][d]}</td>`);
        html += '</tr>';
      });

      html += '</tbody></table>';
      document.getElementById('tabelaResultado').innerHTML = html;
      new Tablesort(document.getElementById('tabela'));
    }

    function exportar() {
      const ws = XLSX.utils.json_to_sheet(planilhaFinal);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Resultado");
      const agora = new Date();
      const nome = `BK26487_${String(agora.getDate()).padStart(2,'0')}${String(agora.getMonth()+1).padStart(2,'0')}${String(agora.getFullYear()).slice(-2)}_${String(agora.getHours()).padStart(2,'0')}${String(agora.getMinutes()).padStart(2,'0')}`;
      XLSX.writeFile(wb, `${nome}.xlsx`);
    }

    function salvarLocalStorage() {
      localStorage.setItem('planilhaFinal', JSON.stringify(planilhaFinal));
    }

    window.addEventListener('load', () => {
      const tabelaSalva = localStorage.getItem('planilhaFinal');
      if (tabelaSalva) {
        planilhaFinal = JSON.parse(tabelaSalva);
        if (planilhaFinal.length > 0) {
          const todosCampos = Object.keys(planilhaFinal[0]);
          const colunasFixas = ["CODPLAT", "DESCRICAO", "CAIXA", "Receber", "ProxEntregaQtde", "ESTOQUE", "DiasDeEstoque", "ReporEstoque", "SugestaoCompra", "COMPRAR", "Media-7", "Media-14", "Pico-14"];
          const dias = todosCampos.filter(c => !colunasFixas.includes(c));
          mostrarTabela(planilhaFinal, dias);
        }
      }
    });

    function aplicarFiltrosExternos() {
      const descFiltro = document.getElementById('filtroDescricao').value.toLowerCase();
      const getMin = id => parseFloat(document.getElementById(id).value);
      const getMax = id => parseFloat(document.getElementById(id).value);

      const recMin = getMin('filtroReceberMin');
      const recMax = getMax('filtroReceberMax');
      const estMin = getMin('filtroEstoqueMin');
      const estMax = getMax('filtroEstoqueMax');
      const sugMin = getMin('filtroReporEstoqueMin');
      const sugMax = getMax('filtroReporEstoqueMax');
      const comMin = getMin('filtroComprarMin');
      const comMax = getMax('filtroComprarMax');

      document.querySelectorAll('#tabela tbody tr').forEach(tr => {
        const tds = tr.querySelectorAll('td');
        const desc = tds[1].textContent.toLowerCase();
        const rec = parseFloat(tds[3].textContent);
        const est = parseFloat(tds[5].textContent);
        const sug = parseFloat(tds[7].textContent);
        const com = parseFloat(tr.querySelector('input[type=number]').value);

        const dentro = (val, min, max) => ((!isNaN(min) ? val >= min : true) && (!isNaN(max) ? val <= max : true));
        const mostrar = desc.includes(descFiltro) && dentro(rec, recMin, recMax) && dentro(est, estMin, estMax) && dentro(sug, sugMin, sugMax) && dentro(com, comMin, comMax);
        tr.style.display = mostrar ? '' : 'none';
      });
    }

    function carregarArquivosDaPasta() {
      const folderInput = document.getElementById('folderUpload');
      const arquivosSelecionados = folderInput.files;

      if (!arquivosSelecionados.length) {
        alert("Nenhuma pasta ou arquivos foram selecionados.");
        return;
      }

      const atribuicoes = {};
      for (const file of arquivosSelecionados) {
        const nomeArquivo = file.name.toUpperCase();
        for (const substring in mapaArquivos) {
          if (nomeArquivo.includes(substring)) {
            const idInput = mapaArquivos[substring];
            atribuicoes[idInput] = file;
            break;
          }
        }
      }

      for (const id in mapaArquivos) {
        const inputId = mapaArquivos[id];
        const input = document.getElementById(inputId);
        if (atribuicoes[inputId]) {
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(atribuicoes[inputId]);
          input.files = dataTransfer.files;
        } else {
          console.warn(`Arquivo correspondente a "${id}" não foi encontrado.`);
        }
      }

      alert("Arquivos atribuídos automaticamente com base na pasta. Clique em REPROCESSAR.");
    }
  </script>
</body>
</html>
